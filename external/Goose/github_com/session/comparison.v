(* autogenerated from command-line-arguments *)
From Perennial.goose_lang Require Import prelude.

Section code.
Context `{ext_ty: ext_types}.

Definition Server := struct.decl [
  "Id" :: uint64T;
  "Data" :: uint64T;
  "VectorClock" :: slice.T uint64T
].

Definition ClientRequest := struct.decl [
  "OperationType" :: uint64T;
  "Data" :: uint64T;
  "ReadVector" :: slice.T uint64T;
  "WriteVector" :: slice.T uint64T
].

Definition ClientReply := struct.decl [
  "Succeeded" :: boolT;
  "OperationType" :: uint64T;
  "Data" :: uint64T
].

Definition compareVersionVector: val :=
  rec: "compareVersionVector" "v1" "v2" :=
    let: "output" := ref_to boolT #true in
    let: "i" := ref_to uint64T #0 in
    let: "l" := ref_to uint64T (slice.len "v1") in
    Skip;;
    (for: (λ: <>, (![uint64T] "i") < (![uint64T] "l")); (λ: <>, Skip) := λ: <>,
      (if: (SliceGet uint64T "v1" (![uint64T] "i")) < (SliceGet uint64T "v2" (![uint64T] "i"))
      then
        "output" <-[boolT] #false;;
        Break
      else
        "i" <-[uint64T] ((![uint64T] "i") + #1);;
        Continue));;
    ![boolT] "output".

Definition RYWDependencyCheck: val :=
  rec: "RYWDependencyCheck" "server" "request" :=
    compareVersionVector (struct.get Server "VectorClock" "server") (struct.get ClientRequest "ReadVector" "request").

Definition MRDependencyCheck: val :=
  rec: "MRDependencyCheck" "server" "request" :=
    compareVersionVector (struct.get Server "VectorClock" "server") (struct.get ClientRequest "ReadVector" "request").

Definition MWDependencyCheck: val :=
  rec: "MWDependencyCheck" "server" "request" :=
    compareVersionVector (struct.get Server "VectorClock" "server") (struct.get ClientRequest "ReadVector" "request").

Definition WFRDependencyCheck: val :=
  rec: "WFRDependencyCheck" "server" "request" :=
    compareVersionVector (struct.get Server "VectorClock" "server") (struct.get ClientRequest "ReadVector" "request").

Definition dependencyCheck: val :=
  rec: "dependencyCheck" "server" "request" :=
    let: "output" := ref (zero_val boolT) in
    (if: (struct.get ClientRequest "OperationType" "request") = #0
    then "output" <-[boolT] (compareVersionVector (struct.get Server "VectorClock" "server") (struct.get ClientRequest "ReadVector" "request"))
    else #());;
    (if: (struct.get ClientRequest "OperationType" "request") = #1
    then "output" <-[boolT] (compareVersionVector (struct.get Server "VectorClock" "server") (struct.get ClientRequest "ReadVector" "request"))
    else #());;
    (if: (struct.get ClientRequest "OperationType" "request") = #2
    then "output" <-[boolT] (compareVersionVector (struct.get Server "VectorClock" "server") (struct.get ClientRequest "WriteVector" "request"))
    else #());;
    (if: (struct.get ClientRequest "OperationType" "request") = #3
    then "output" <-[boolT] (compareVersionVector (struct.get Server "VectorClock" "server") (struct.get ClientRequest "WriteVector" "request"))
    else #());;
    (if: (struct.get ClientRequest "OperationType" "request") = #4
    then "output" <-[boolT] ((compareVersionVector (struct.get Server "VectorClock" "server") (struct.get ClientRequest "ReadVector" "request")) && (compareVersionVector (struct.get Server "VectorClock" "server") (struct.get ClientRequest "WriteVector" "request")))
    else #());;
    ![boolT] "output".

End code.
